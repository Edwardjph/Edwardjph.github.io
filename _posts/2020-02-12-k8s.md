---
title: Centos安装docker与k8s
tags: k8s，docker
---



---

### 一、环境说明

##### 系统

```shell
cat /etc/redhat-release
CentOS Linux release 7.7.1908 (Core）
```

##### 配置固定ip

```shell
vi /etc/sysconfig/network-scripts/ifcfg-ens33
```

​	修改:

```shell
BOOTPROTO=“static”
```

​	增加：

​	![image-20200213153447775](\assets\images\k8s\image-20200213153447775.png)

##### 修改hostname	

```shell
hostnamectl set-hostname master
hostnamectl status
echo "127.0.0.1 $(hostname)" >> /etc/hosts
```



### 二、设置代理

##### 1.系统级代理

```shell
/etc/profile
```

在最后加入：

```shell
export proxy="http://192.168.1.56:1080" 
export http_proxy=$proxy 
export https_proxy=$proxy 
export ftp_proxy=$proxy 
export no_proxy="localhost, 127.0.0.1, ::1"
```

```shell
source /etc/profile
```

##### 2.yum代理

```shell
/etc/yum.conf
```

在最后加入：

```shell
proxy=http://192.168.1.56:1080/
```



### 三、安装docker（）

[docker官网安装步骤](https://docs.docker.com/install/linux/docker-ce/centos/)

##### 1.卸载旧版本：

```shell
yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
```

##### 2.安装所需的软件包：

```shell
yum install -y yum-utils \
  device-mapper-persistent-data \
  lvm2
```

##### 3.设置稳定的存储库：

```shell
yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
```

##### 4.安装DOCKER ENGINE - COMMUNITY

```shell
yum install docker-ce docker-ce-cli containerd.io
```

##### 5.设置docker代理：[设置代理](https://docs.docker.com/config/daemon/systemd/)

```shell
mkdir -p /etc/systemd/system/docker.service.d
vi /etc/systemd/system/docker.service.d/http-proxy.conf
```

添加：

```shell
[Service]
Environment="HTTP_PROXY=http://192.168.1.56:1080/""HTTPS_PROXY=http://192.168.1.56:1080/"
```

更新配置：

```shell
systemctl daemon-reload
```

验证配置是否加载：

```shell
systemctl show --property=Environment docker
```

##### 6.启动docker：

```shell
systemctl start docker
```



### 四、安装k8s（master节点）

##### 1.关闭swap

临时关闭：

```shell
swapoff -a
```

永久关闭：

```shell
vi /etc/fstab
```

将其中swap一行注释掉

##### 2.关闭防火墙

```shell
systemctl stop firewalld
systemctl disable firewalld
```

##### 3.关闭SELinux

```
setenforce 0
sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
```

##### 4.添加yun仓库

```shell
vi /etc/yum.repos.d/kubernetes.repo
```

写入：（节点在国外，使用google官方镜像仓库）

```shell
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kube*
```

（节点在国内，使用阿里云仓库）

```shell
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
```

##### 5.修改sysctl内核参数：

```shell
vi /etc/sysctl.d/k8s.conf
```

加入：

```shell
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
vm.swappiness=0
```

```shell
sysctl --system
```

##### 6.安装kubeadm，kubelet，kubectl

```shell
yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
systemctl enable --now kubelet
```

##### 7.拉取镜像（需docker配置代理）

```shell
kubeadm config images pull
```

##### 8.安装网络插件

```shell
yum insatll flanneld
```

##### 9.初始化集群

```shell
kubeadm init --pod-network-cidr=10.244.0.0/16
```

保存屏幕文字，后续worker节点将用到